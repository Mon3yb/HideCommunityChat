name: Attach addon zip to releases

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-upload-zip:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Determine release info
      - name: Determine release info
        id: info
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -n "${{ github.event.release.tag_name }}" ]; then
            TAG="${{ github.event.release.tag_name }}"
            RELEASE_NAME="${{ github.event.release.name }}"
          else
            TAG=$(gh release list --limit 1 --json tagName --jq '.[0].tagName')
            RELEASE_NAME=$(gh release view "$TAG" --json name --jq '.name')
          fi

          # Trim whitespace
          RELEASE_NAME="$(echo "$RELEASE_NAME" | xargs)"

          # Strip leading v
          CLEAN_VERSION="${RELEASE_NAME#v}"

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$CLEAN_VERSION" >> "$GITHUB_OUTPUT"

      # Prepare addon folder
      - name: Prepare addon folder
        run: |
          ADDON_NAME="HideCommunityChat"
          mkdir "$ADDON_NAME"
          cp -r $ADDON_NAME.* "$ADDON_NAME"/ || true

      # Remove excluded files
      - name: Remove excluded files
        run: |
          ADDON_NAME="HideCommunityChat"

          EXCLUDE_LIST=(
            "LICENSE"
            "*.md"
            ".github"
          )

          for pattern in "${EXCLUDE_LIST[@]}"; do
            matches=$(find "$ADDON_NAME" -type f -name "$pattern" 2>/dev/null || true)
            if [ -n "$matches" ]; then
              while IFS= read -r file; do
                rm "$file"
              done <<< "$matches"
            fi
          done

      # Create final zip: HideCommunityChat-1.0.0.zip
      - name: Create zip
        id: create_zip
        run: |
          REPO="${{ github.event.repository.name }}"
          VERSION="${{ steps.info.outputs.version }}"
          ADDON_NAME="HideCommunityChat"

          ZIP_NAME="${REPO}-${VERSION}.zip"
          echo "Creating zip: $ZIP_NAME"

          zip -r "$ZIP_NAME" "$ADDON_NAME"

          echo "zip_name=$ZIP_NAME" >> $GITHUB_OUTPUT

      # Upload zip to the release
      - name: Upload zip to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${{ steps.info.outputs.tag }}"
          ZIP_NAME="${{ steps.create_zip.outputs.zip_name }}"
          gh release upload "$TAG_NAME" "$ZIP_NAME" --clobber
