name: Build release zip

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build-zip:
    runs-on: ubuntu-latest

    env:
      # Repo name from the event payload, e.g. "HideCommunityChat"
      REPO_NAME: ${{ github.event.repository.name }}
      # Tag name of the release, e.g. "v1.0.0" or "1.0.0"
      TAG_NAME: ${{ github.event.release.tag_name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Compute archive name
        id: vars
        run: |
          # Strip a leading "v" from the tag if present (v1.0.0 -> 1.0.0)
          VERSION="${TAG_NAME#v}"

          ZIP_NAME="${REPO_NAME}-${VERSION}.zip"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "zip_name=$ZIP_NAME" >> "$GITHUB_OUTPUT"

            # Remove files you don't want in the zip
            
      - name: Remove excluded files
        run: |
          ADDON_NAME="HideCommunityChat"

          # Define files or patterns to exclude (relative to addon root)
          EXCLUDE_LIST=(
            "LICENSE"
            "*.md"
            ".github"
          )

          for pattern in "${EXCLUDE_LIST[@]}"; do
            matches=$(find "$ADDON_NAME" -type f -name "$pattern" 2>/dev/null || true)

            if [ -n "$matches" ]; then
              echo "Excluding pattern '$pattern':"
              echo "$matches"
              while IFS= read -r file; do
                rm "$file"
              done <<< "$matches"
            else
              echo "No matches for pattern '$pattern'"
            fi
          done

      - name: Create zip file
        run: |
          ZIP_NAME='${{ steps.vars.outputs.zip_name }}'
          zip -r "$ZIP_NAME" .

      - name: Upload zip as release asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME='${{ github.event.release.tag_name }}'
          ZIP_NAME='${{ steps.vars.outputs.zip_name }}'

          echo "Uploading $ZIP_NAME to release $TAG_NAME"

          # GitHub CLI is available on GitHub-hosted runners.
          gh release upload "$TAG_NAME" "$ZIP_NAME" --clobber
